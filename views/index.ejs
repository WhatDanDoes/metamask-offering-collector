<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="<%= process.env.TITLE %>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= process.env.TITLE %></title>
    <link rel='stylesheet' href='/stylesheets/mvp.css' />
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <header>
      <nav>
        <a id="home-link" href="/"><img alt="Logo" src="https://via.placeholder.com/200x70?text=Logo" height="70"></a>
        <ul>
          <li id="connect-metamask">
            <% if (agent) { %>
              <a href="/auth/disconnect">
                <button id="disconnect-metamask-button" type="submit">Disconnect Metamask</button>
              </a>
            <% } else { %>
              <form id="introduction-form" action="/auth/introduce" method="post" onsubmit="return handleIdentification(event)">
                <input type="hidden" name="publicAddress">
                <button id="connect-metamask-button" type="submit">Confirm your identity with Metamask</button>
              </form>
            <% } %>
          </li>
        </ul>
      </nav>
    </header>
    <main>
      <% include _partials/messages %>
      <h1><%= title %></h1>
      <p>Proverbs 3:9-10</p>
    </main>
    <script>
      /**
       * 2021-9-27 Adapted from https://docs.metamask.io/guide/create-dapp.html
       */
      document.addEventListener('DOMContentLoaded', function(event) {
        //const connectMetamask = document.getElementById('connect-metamask');

        // Created check function to see if the MetaMask extension is installed
        const isMetaMaskInstalled = () => {
          // Have to check the ethereum binding on the window object to see if it's installed
          const { ethereum } = window;
          return Boolean(ethereum && ethereum.isMetaMask);
        };

        if (isMetaMaskInstalled()) {
          handleIdentification = (e) => {
            e.preventDefault();

            document.getElementById("connect-metamask-button").disabled = true;
            ethereum.request({ method: 'eth_requestAccounts' }).then(accounts => {

              const account = accounts[0];

              document.querySelector('input[name="publicAddress"]').value = account;
              e.target.submit();
            }).catch(err => {
              console.error('Something dreadful happened when accessing your account');
              console.error(err);
            });
          };
        }
        else {
          document.getElementById('connect-metamask').innerHTML = 'Click here to install the Metamask browser plugin';
        }
      });
    </script>
  </body>
</html>
