<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="<%= process.env.TITLE %>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= process.env.TITLE %></title>
    <link rel='stylesheet' href='/stylesheets/mvp.css' />
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <header>
      <nav>
        <a id="home-link" href="/">Metamask is asking you to sign a message</a>
      </nav>
    </header>
    <% include _partials/messages %>
    <main>
      <h1>Signing proves that you own the account you provided</h1>

      <form id="signed-message-form" action="/auth/prove" method="post">
        <input type="hidden" name="publicAddress" value="<%= publicAddress %>">
        <input type="hidden" name="signature">
      </form>
    </main>
    <script>
      /**
       * 2021-9-27 Adapted from https://docs.metamask.io/guide/create-dapp.html
       */
      document.addEventListener('DOMContentLoaded', function(event) {

        ethereum.request({ method: 'eth_signTypedData_v3', params: ['<%= publicAddress %>', "<%- typedData %>"] }).then(signed => {
          console.log('Signed');
          console.log(signed);

          document.querySelector('input[name="signature"]').value = signed;
          document.getElementById('signed-message-form').submit();
        }).catch(err => {
          console.error('Error:', err);
          window.location = '/'
        });
      });
    </script>
  </body>
</html>
